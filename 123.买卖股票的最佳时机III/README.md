# [123. 买卖股票的最佳时机III](https://leetcode-cn.com/problems/best-time-to-buy-and-sell-stock-iii/solution/mai-mai-gu-piao-de-zui-jia-shi-ji-iii-by-wrnt/)
`DP`

## 动态规划

### 解题思路

1. 在任意交易日结束后，若以 `dp[i][j]` 表示第 i 天持有的收益，存在以下五种状态
   - `dp[i][0]` 第 i 天没持有过股票，收益为 0
   - `dp[i][1]` 第 i 天买进一支股票
   - `dp[i][2]` 第 i 天买进一支股票然后卖出
   - `dp[i][3]` 第 i 天买进第二支股票
   - `dp[i][4]` 第 i 天完成两笔交易

2. 状态转移方程可以描述为：
   - `dp[i][0] = 0` 没有操作，收益始终为 0
   - `dp[i][1] = max(dp[i - 1][1], dp[i - 1][0] - prices[i])` 第 i 天买入股票与第 i - 1 天买入股票的收益最大值
   - `dp[i][2] = max(dp[i - 1][2], dp[i - 1][1] + prices[i])` 第 i 天卖出股票与第 i - 1 天之前卖出股票的收益最大值
   - `dp[i][3] = max(dp[i - 1][3], dp[i - 1][2] - prices[i])` 第 i 天买入第二次股票与第 i - 1 天之前买入第二次股票的收益最大值
   - `dp[i][4] = max(dp[i - 1][4], dp[i - 1][3] + prices[i])` 第 i 天卖出第二次股票与第 i - 1 天之前卖出第二次股票的收益最大值

3. 状态的初始化
   - `dp[0][0]` 第 0 天没持有过股票，收益为 0
   - `dp[0][1]` 第 0 天买入，收益为 -price
   - `dp[0][2]` 第 0 天卖出，收益的最小值为 0
   - `dp[0][3]` 第 0 天买入（第二次），收益为 -price
   - `dp[0][4]` 第 0 天卖出（第二次），收益的最小值为 0

4. 收益最大值
   只有卖出的状态才有最大收益，所以收益应为 0，`dp[i][2]` 和 `dp[i][4]` 三者最大者。又因为 `dp[i][2]` 和 `dp[i][4]` 的起始值就是 0，说明 `dp[i][2]` 和 `dp[i][4]` 必然大于等于 0。如果最大收益是由一笔交易达成的，那么完成两笔交易的情况可包含这笔交易，综上，返回的最大收益必然是 `dp[i][4]`
   

### 复杂度
- 时间复杂度：O(N) 遍历数组
- 空间复杂度：O(1) 优化前使用二维矩阵存储状态，为 O(N)，优化后使用常量保存五种状态，为 O(1)
  